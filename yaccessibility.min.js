/**
 * yAccessibility - Israeli Accessibility Widget
 * Based on: https://github.com/yortem/yAccessibility
 * Hebrew Translation & Israeli Standards Compliance
 */
;((window, document) => {
  var yAccessibility = (options) => {
    var defaults = {
      language: "he",
      statement: "/accessibility-statement.html",
      verticalPosition: "bottom",
      verticalOffset: 20,
      horizontalPosition: "left",
      horizontalOffset: 20,
      contentElementId: null,
      textSize: {
        min: 85,
        max: 150,
        step: 10,
      },
    }

    var settings = Object.assign({}, defaults, options)
    var state = {
      isOpen: false,
      textSize: 100,
      contrast: "normal",
      grayScale: false,
      highlightLinks: false,
      readableFont: false,
      stopAnimations: false,
      bigCursor: false,
    }

    var translations = {
      he: {
        title: "הצהרת נגישות",
        statementLink: "הצהרת נגישות",
        reset: "איפוס הגדרות",
        textSize: "גודל טקסט",
        increaseText: "הגדל טקסט",
        decreaseText: "הקטן טקסט",
        contrast: "ניגודיות",
        normalContrast: "רגילה",
        highContrast: "גבוהה",
        invertedContrast: "מהופכת",
        grayScale: "גווני אפור",
        highlightLinks: "הדגש קישורים",
        readableFont: "גופן קריא",
        stopAnimations: "עצור אנימציות",
        bigCursor: "סמן גדול",
        menuButton: "תפריט נגישות",
        close: "סגור",
      },
    }

    var t = translations[settings.language] || translations.he

    function createStyles() {
      var css = `
        .y-accessibility-btn {
          position: fixed;
          ${settings.verticalPosition}: ${settings.verticalOffset}px;
          ${settings.horizontalPosition}: ${settings.horizontalOffset}px;
          z-index: 999999;
          background: #4f7aeb;
          color: #fff;
          border: none;
          border-radius: 50px;
          padding: 12px 20px;
          font-family: 'Alef', Arial, sans-serif;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.3s ease;
        }
        .y-accessibility-btn:hover {
          background: #3d67d9;
          transform: translateY(-2px);
          box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }
        .y-accessibility-btn:focus {
          outline: 3px solid rgba(79, 122, 235, 0.4);
          outline-offset: 2px;
        }
        .y-accessibility-icon {
          font-size: 20px;
        }
        .y-accessibility-panel {
          position: fixed;
          ${settings.verticalPosition}: ${settings.verticalOffset + 60}px;
          ${settings.horizontalPosition}: ${settings.horizontalOffset}px;
          z-index: 999998;
          background: #fff;
          color: #1a1d29;
          border: 1px solid #e2e8f0;
          border-radius: 12px;
          box-shadow: 0 8px 24px rgba(0,0,0,0.12);
          width: 320px;
          max-height: 80vh;
          overflow-y: auto;
          padding: 20px;
          display: none;
          font-family: 'Alef', Arial, sans-serif;
        }
        .y-accessibility-panel.open {
          display: block;
          animation: yAccessSlideIn 0.3s ease;
        }
        @keyframes yAccessSlideIn {
          from {
            opacity: 0;
            transform: translateY(10px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        .y-accessibility-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
          padding-bottom: 15px;
          border-bottom: 1px solid #e2e8f0;
        }
        .y-accessibility-title {
          font-size: 18px;
          font-weight: 700;
          margin: 0;
        }
        .y-accessibility-close {
          background: none;
          border: none;
          font-size: 24px;
          cursor: pointer;
          color: #4a5568;
          padding: 0;
          width: 30px;
          height: 30px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
        }
        .y-accessibility-close:hover {
          background: #f1f3f5;
          color: #1a1d29;
        }
        .y-accessibility-option {
          margin-bottom: 20px;
        }
        .y-accessibility-option-title {
          font-size: 14px;
          font-weight: 600;
          margin-bottom: 8px;
          display: block;
        }
        .y-accessibility-control {
          display: flex;
          gap: 8px;
          flex-wrap: wrap;
        }
        .y-accessibility-btn-control {
          flex: 1;
          min-width: 80px;
          padding: 10px 16px;
          background: #f1f3f5;
          border: 2px solid transparent;
          border-radius: 8px;
          cursor: pointer;
          font-family: inherit;
          font-size: 14px;
          font-weight: 500;
          transition: all 0.2s ease;
          color: #1a1d29;
        }
        .y-accessibility-btn-control:hover {
          background: #e2e8f0;
        }
        .y-accessibility-btn-control:focus {
          outline: 2px solid #4f7aeb;
          outline-offset: 2px;
        }
        .y-accessibility-btn-control.active {
          background: rgba(79, 122, 235, 0.1);
          border-color: #4f7aeb;
          color: #4f7aeb;
        }
        .y-accessibility-text-size {
          display: flex;
          align-items: center;
          gap: 12px;
        }
        .y-accessibility-text-size button {
          width: 40px;
          height: 40px;
          border-radius: 8px;
          font-size: 18px;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 0;
        }
        .y-accessibility-text-size span {
          font-size: 16px;
          font-weight: 600;
          min-width: 50px;
          text-align: center;
        }
        .y-accessibility-footer {
          margin-top: 20px;
          padding-top: 15px;
          border-top: 1px solid #e2e8f0;
          display: flex;
          gap: 8px;
        }
        .y-accessibility-footer button,
        .y-accessibility-footer a {
          flex: 1;
          padding: 10px;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 500;
          text-align: center;
          text-decoration: none;
          transition: all 0.2s ease;
        }
        .y-accessibility-reset {
          background: #f1f3f5;
          border: none;
          color: #1a1d29;
          cursor: pointer;
        }
        .y-accessibility-reset:hover {
          background: #e2e8f0;
        }
        .y-accessibility-statement {
          background: #4f7aeb;
          color: #fff;
          border: none;
        }
        .y-accessibility-statement:hover {
          background: #3d67d9;
        }
        
        /* Accessibility Effects */
        body.y-access-grayscale {
          filter: grayscale(100%);
        }
        body.y-access-highlight-links a {
          outline: 2px solid #4f7aeb !important;
          outline-offset: 2px !important;
          text-decoration: underline !important;
        }
        body.y-access-readable-font,
        body.y-access-readable-font * {
          font-family: Arial, sans-serif !important;
        }
        body.y-access-stop-animations,
        body.y-access-stop-animations * {
          animation: none !important;
          transition: none !important;
        }
        body.y-access-big-cursor,
        body.y-access-big-cursor * {
          cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><circle cx="20" cy="20" r="18" fill="black" stroke="white" stroke-width="2"/></svg>') 20 20, auto !important;
        }
        body.y-access-contrast-high {
          background: #000 !important;
          color: #fff !important;
        }
        body.y-access-contrast-high * {
          background: #000 !important;
          color: #fff !important;
          border-color: #fff !important;
        }
        body.y-access-contrast-inverted {
          filter: invert(1) hue-rotate(180deg);
        }
        
        @media (max-width: 600px) {
          .y-accessibility-panel {
            width: calc(100vw - 40px);
            max-width: 320px;
          }
        }
      `

      var styleEl = document.createElement("style")
      styleEl.textContent = css
      document.head.appendChild(styleEl)
    }

    function applyTextSize() {
      var contentEl = settings.contentElementId ? document.getElementById(settings.contentElementId) : document.body
      if (contentEl) {
        contentEl.style.fontSize = state.textSize + "%"
      }
    }

    function applyContrast() {
      document.body.classList.remove("y-access-contrast-high", "y-access-contrast-inverted")
      if (state.contrast === "high") {
        document.body.classList.add("y-access-contrast-high")
      } else if (state.contrast === "inverted") {
        document.body.classList.add("y-access-contrast-inverted")
      }
    }

    function toggleFeature(feature) {
      state[feature] = !state[feature]
      var className = "y-access-" + feature.replace(/([A-Z])/g, "-$1").toLowerCase()
      document.body.classList.toggle(className, state[feature])
      saveState()
      updateUI()
    }

    function saveState() {
      try {
        localStorage.setItem("yAccessibility", JSON.stringify(state))
      } catch (e) {
        console.warn("Could not save accessibility settings")
      }
    }

    function loadState() {
      try {
        var saved = localStorage.getItem("yAccessibility")
        if (saved) {
          state = Object.assign({}, state, JSON.parse(saved))
        }
      } catch (e) {
        console.warn("Could not load accessibility settings")
      }
    }

    function resetAll() {
      state = {
        isOpen: state.isOpen,
        textSize: 100,
        contrast: "normal",
        grayScale: false,
        highlightLinks: false,
        readableFont: false,
        stopAnimations: false,
        bigCursor: false,
      }

      document.body.classList.remove(
        "y-access-grayscale",
        "y-access-highlight-links",
        "y-access-readable-font",
        "y-access-stop-animations",
        "y-access-big-cursor",
        "y-access-contrast-high",
        "y-access-contrast-inverted",
      )

      var contentEl = settings.contentElementId ? document.getElementById(settings.contentElementId) : document.body
      if (contentEl) {
        contentEl.style.fontSize = ""
      }

      saveState()
      updateUI()
    }

    function updateUI() {
      // Update text size display
      var textSizeValue = document.querySelector(".y-accessibility-text-size span")
      if (textSizeValue) {
        textSizeValue.textContent = state.textSize + "%"
      }

      // Update contrast buttons
      document
        .querySelectorAll("[data-contrast]")
        .forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.contrast === state.contrast)
        })

      // Update toggle buttons
      ;["grayScale", "highlightLinks", "readableFont", "stopAnimations", "bigCursor"].forEach((feature) => {
        var btn = document.querySelector('[data-feature="' + feature + '"]')
        if (btn) {
          btn.classList.toggle("active", state[feature])
          btn.setAttribute("aria-pressed", state[feature])
        }
      })
    }

    function createWidget() {
      // Create button
      var btn = document.createElement("button")
      btn.className = "y-accessibility-btn"
      btn.setAttribute("aria-label", t.menuButton)
      btn.setAttribute("aria-haspopup", "dialog")
      btn.setAttribute("aria-expanded", "false")
      btn.innerHTML = '<span class="y-accessibility-icon" aria-hidden="true">♿</span><span>' + t.menuButton + "</span>"

      // Create panel
      var panel = document.createElement("div")
      panel.className = "y-accessibility-panel"
      panel.setAttribute("role", "dialog")
      panel.setAttribute("aria-modal", "false")
      panel.setAttribute("aria-labelledby", "y-access-title")

      panel.innerHTML = `
        <div class="y-accessibility-header">
          <h2 id="y-access-title" class="y-accessibility-title">${t.title}</h2>
          <button class="y-accessibility-close" aria-label="${t.close}">×</button>
        </div>
        
        <div class="y-accessibility-option">
          <span class="y-accessibility-option-title">${t.textSize}</span>
          <div class="y-accessibility-text-size">
            <button class="y-accessibility-btn-control" data-action="decreaseText" aria-label="${t.decreaseText}">−</button>
            <span>${state.textSize}%</span>
            <button class="y-accessibility-btn-control" data-action="increaseText" aria-label="${t.increaseText}">+</button>
          </div>
        </div>
        
        <div class="y-accessibility-option">
          <span class="y-accessibility-option-title">${t.contrast}</span>
          <div class="y-accessibility-control">
            <button class="y-accessibility-btn-control" data-contrast="normal" aria-pressed="false">${t.normalContrast}</button>
            <button class="y-accessibility-btn-control" data-contrast="high" aria-pressed="false">${t.highContrast}</button>
            <button class="y-accessibility-btn-control" data-contrast="inverted" aria-pressed="false">${t.invertedContrast}</button>
          </div>
        </div>
        
        <div class="y-accessibility-option">
          <button class="y-accessibility-btn-control" data-feature="grayScale" aria-pressed="false">${t.grayScale}</button>
        </div>
        
        <div class="y-accessibility-option">
          <button class="y-accessibility-btn-control" data-feature="highlightLinks" aria-pressed="false">${t.highlightLinks}</button>
        </div>
        
        <div class="y-accessibility-option">
          <button class="y-accessibility-btn-control" data-feature="readableFont" aria-pressed="false">${t.readableFont}</button>
        </div>
        
        <div class="y-accessibility-option">
          <button class="y-accessibility-btn-control" data-feature="stopAnimations" aria-pressed="false">${t.stopAnimations}</button>
        </div>
        
        <div class="y-accessibility-option">
          <button class="y-accessibility-btn-control" data-feature="bigCursor" aria-pressed="false">${t.bigCursor}</button>
        </div>
        
        <div class="y-accessibility-footer">
          <button class="y-accessibility-reset" data-action="reset">${t.reset}</button>
          <a href="${settings.statement}" class="y-accessibility-statement" target="_blank">${t.statementLink}</a>
        </div>
      `

      document.body.appendChild(btn)
      document.body.appendChild(panel)

      // Event listeners
      btn.addEventListener("click", () => {
        state.isOpen = !state.isOpen
        panel.classList.toggle("open", state.isOpen)
        btn.setAttribute("aria-expanded", state.isOpen)
      })

      panel.querySelector(".y-accessibility-close").addEventListener("click", () => {
        state.isOpen = false
        panel.classList.remove("open")
        btn.setAttribute("aria-expanded", "false")
      })

      panel.addEventListener("click", (e) => {
        var target = e.target.closest("[data-action], [data-contrast], [data-feature]")
        if (!target) return

        if (target.dataset.action === "increaseText") {
          if (state.textSize < settings.textSize.max) {
            state.textSize += settings.textSize.step
            applyTextSize()
            saveState()
            updateUI()
          }
        } else if (target.dataset.action === "decreaseText") {
          if (state.textSize > settings.textSize.min) {
            state.textSize -= settings.textSize.step
            applyTextSize()
            saveState()
            updateUI()
          }
        } else if (target.dataset.action === "reset") {
          resetAll()
        } else if (target.dataset.contrast) {
          state.contrast = target.dataset.contrast
          applyContrast()
          saveState()
          updateUI()
        } else if (target.dataset.feature) {
          toggleFeature(target.dataset.feature)
        }
      })

      // Close on escape
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && state.isOpen) {
          state.isOpen = false
          panel.classList.remove("open")
          btn.setAttribute("aria-expanded", "false")
          btn.focus()
        }
      })
    }

    function init() {
      loadState()
      createStyles()
      createWidget()
      applyTextSize()
      applyContrast()

      // Apply saved features
      if (state.grayScale) toggleFeature("grayScale")
      if (state.highlightLinks) toggleFeature("highlightLinks")
      if (state.readableFont) toggleFeature("readableFont")
      if (state.stopAnimations) toggleFeature("stopAnimations")
      if (state.bigCursor) toggleFeature("bigCursor")

      updateUI()
    }

    // Initialize when DOM is ready
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init)
    } else {
      init()
    }
  }

  // Export
  window.yAccessibility = yAccessibility
})(window, document)
